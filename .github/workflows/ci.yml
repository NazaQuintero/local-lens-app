name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true          # FALLA si coverage no cumple
    
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total.lines.pct;
            const meetsThreshold = total >= 70;
            const color = meetsThreshold ? '🟢' : '🔴';
            const status = meetsThreshold ? 'CUMPLE' : 'NO CUMPLE';
            const message = meetsThreshold ? 
              `✅ **Cobertura de código**: ${total}% de líneas cubiertas\n\n🎯 **Verificación de umbral**: ${status} (Requerido: 70%)\n\n📊 **Reporte detallado**: [Ver Cobertura](https://codecov.io/gh/${{ github.repository }}/commit/${{ github.sha }})` :
              `❌ **Cobertura de código**: ${total}% de líneas cubiertas\n\n🚫 **Verificación de umbral**: ${status} (Requerido: 70%)\n\n⚠️ **Este PR no se puede mergear** hasta que la cobertura sea >= 70%\n\n📊 **Reporte detallado**: [Ver Cobertura](https://codecov.io/gh/${{ github.repository }}/commit/${{ github.sha }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
          } catch (error) {
            console.log('Reporte de cobertura no encontrado, omitiendo comentario');
          }

  notify-discord:
    needs: test
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Notify Discord on failure
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: |
          🚨 **CI Falló** 🚨
          **Repositorio**: ${{ github.repository }}
          **Rama**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Autor**: ${{ github.actor }}
          **Motivo**: Falla en tests o cobertura de código < 70%
          [Ver Detalles](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
